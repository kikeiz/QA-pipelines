name: Deploy to Dev (.NET)

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  build_and_test: 
    uses: ./.github/workflows/reusable/verify-dotnet.yml
    with:
      dotnet_version: '9.0.x'

  check_if_deploy_needed:
    needs: build_and_test
    uses: ./.github/workflows/reusable/check-if-needs-deploy.yml

  build_and_push:
    needs: check_if_deploy_needed 
    if: needs.check_if_deploy_needed.outputs.deploy == 'true'
    uses: ./.github/workflows/reusable/build-push-image.yml
    with:
      image_tag: dev
      environment: development

  deploy_to_ecs:
    needs: build_and_push
    uses: ./.github/workflows/reusable/deploy-ecs.yml
    with:
      image: ${{ needs.build_and_push.outputs.build }}
      environment: development
      environment_variables: |
        AWS_REGION=${{ vars.AWS_REGION }}
        QA_SQS_QUEUE_URL=${{ vars.QA_SQS_QUEUE_URL }}
        REMARKETING_SERVICE_QUEUE_URL=${{ vars.REMARKETING_SERVICE_QUEUE_URL }}
        ASPNETCORE_ENVIRONMENT=Development
        QA_PROCESS_TABLE=${{ vars.QA_PROCESS_TABLE }}
        USER_TABLE=${{ vars.USER_TABLE }}
        MAX_NUM_PROCESSES=${{ vars.MAX_NUM_PROCESSES }}

  delete_ecr_tag: 
    needs: deploy_to_ecs
    uses: ./.github/workflows/reusable/delete-ecr-tag.yml
    with:
      environment: development
      tag: dev