name: Release to Staging (.NET)

on:
  push:
    branches:
      - release/*
  pull_request:
    types: [closed]
    branches:
      - release/*

jobs:
  should-run:
    runs-on: ubuntu-latest
    outputs:
      continue: ${{ steps.set.outputs.should_run }}
    steps:
      - id: set
        run: |
          if [[ "${{ github.event_name}}" != "pull_request" || "${{github.event.pull_request.head.repo.full_name}}" != "${{github.event.pull_request.base.repo.full_name}}" ]]; then
            echo "✅ Workflow should run"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Workflow should NOT run"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build_and_test:
    needs: should-run
    if: needs.should-run.outputs.continue == 'true'
    uses: kikeiz/shared-workflows/.github/workflows/verify-dotnet.yml@v1
    with:
      dotnet_version: '9.0.x'

  build_and_push_image:
    needs: build_and_test
    uses: kikeiz/shared-workflows/.github/workflows/build-push-image.yml@v1
    with:
      image_tag: release
      environment: staging
    secrets: inherit

  export_vars:
    needs: build_and_push_image
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      AWS_REGION: ${{ steps.vars.outputs.AWS_REGION }}
      QA_SQS_QUEUE_URL: ${{ steps.vars.outputs.QA_SQS_QUEUE_URL }}
      REMARKETING_SERVICE_QUEUE_URL: ${{ steps.vars.outputs.REMARKETING_SERVICE_QUEUE_URL }}
      QA_PROCESS_TABLE: ${{ steps.vars.outputs.QA_PROCESS_TABLE }}
      USER_TABLE: ${{ steps.vars.outputs.USER_TABLE }}
      MAX_NUM_PROCESSES: ${{ steps.vars.outputs.MAX_NUM_PROCESSES }}
      IMAGE: ${{ steps.vars.outputs.IMAGE }}

    steps:
      - id: vars
        run: |
          echo "AWS_REGION=${{ vars.AWS_REGION }}" >> $GITHUB_OUTPUT
          echo "QA_SQS_QUEUE_URL=${{ vars.QA_SQS_QUEUE_URL }}" >> $GITHUB_OUTPUT
          echo "REMARKETING_SERVICE_QUEUE_URL=${{ vars.REMARKETING_SERVICE_QUEUE_URL }}" >> $GITHUB_OUTPUT
          echo "QA_PROCESS_TABLE=${{ vars.QA_PROCESS_TABLE }}" >> $GITHUB_OUTPUT
          echo "USER_TABLE=${{ vars.USER_TABLE }}" >> $GITHUB_OUTPUT
          echo "MAX_NUM_PROCESSES=${{ vars.MAX_NUM_PROCESSES }}" >> $GITHUB_OUTPUT
          echo "IMAGE=${{ vars.ECR_REPO }}:release" >> $GITHUB_OUTPUT
      
  deploy_to_ecs:
    needs: [export_vars, build_and_push_image]
    uses: kikeiz/shared-workflows/.github/workflows/deploy-ecs.yml@v1
    with:
      image: ${{ needs.export_vars.outputs.IMAGE }}
      environment: staging
      environment_variables: |
        AWS_REGION=${{ needs.export_vars.outputs.AWS_REGION }}
        QA_SQS_QUEUE_URL=${{ needs.export_vars.outputs.QA_SQS_QUEUE_URL }}
        REMARKETING_SERVICE_QUEUE_URL=${{ needs.export_vars.outputs.REMARKETING_SERVICE_QUEUE_URL }}
        ASPNETCORE_ENVIRONMENT=Staging
        QA_PROCESS_TABLE=${{ needs.export_vars.outputs.QA_PROCESS_TABLE }}
        USER_TABLE=${{ needs.export_vars.outputs.USER_TABLE }}
        MAX_NUM_PROCESSES=${{ needs.export_vars.outputs.MAX_NUM_PROCESSES }}
    secrets: inherit